<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Quiz</title>
	<script src="./lib/jquery-1.6.1.js" type="text/javascript" charset="utf-8"></script>
	<script src="./lib/underscore.js" type="text/javascript" charset="utf-8"></script>
	<script src="./lib/backbone.js" type="text/javascript" charset="utf-8"></script>
	<script src="../backbone-relational.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
	<div></div>
	<script type="text/javascript" charset="utf-8">
	/*House = Backbone.RelationalModel.extend({
		// The 'relations' property, on the House's prototype. Initialized separately for each instance of House.
		// Each relation must define (as a minimum) the 'type', 'key' and 'relatedModel'. Options are
		// 'includeInJSON', 'createModels' and 'reverseRelation', which takes the same options as the relation itself.
		relations: [
			{
				type: Backbone.HasMany, // Use the type, or the string 'HasOne' or 'HasMany'.
				key: 'occupants',
				relatedModel: 'Person',
				includeInJSON: Backbone.Model.prototype.idAttribute,
				collectionType: 'PersonCollection',
				reverseRelation: {
					key: 'livesIn'
				}
			}
		]
	});

	Person = Backbone.RelationalModel.extend({
		relations: [
			{ // Create a (recursive) one-to-one relationship
				type: Backbone.HasOne,
				key: 'user',
				relatedModel: 'User',
				reverseRelation: {
					type: Backbone.HasOne,
					key: 'person'
				}
			}
		],
		
		initialize: function() {
			// do whatever you want :)
		}
	});

	PersonCollection = Backbone.Collection.extend({
		url: function( models ) {
			// Logic to create a url for the whole collection, or a set of models.
			// See the tests, or Backbone-tastypie, for an example.
			return '/person/' + ( models ? 'set/' + _.pluck( models, 'id' ).join(';') + '/' : '' );
		}
	});
	
	User = Backbone.RelationalModel.extend();
	
	paul = new Person({
		id: 'person-1',
		name: 'Paul',
		user: { id: 'user-1', login: 'dude', email: 'me@gmail.com' }
	});
	
	paul = new Person({
		id: 'person-2',
		name: 'Joe'
	});
	
	/*console.debug( paul.get('user').get('login') );
	
	ourHouse = new House({
		id: 'house-1',
		location: 'in the middle of the street',
		occupants: ['person-1', 'person-2', 'person-5']
	});
	
	console.debug( ourHouse.get('occupants').at(0) );*/
	
	/*var Child = Backbone.RelationalModel.extend({})
	var Mother = Backbone.RelationalModel.extend({ relations: [ {type: Backbone.HasMany, key: "children", relatedModel: "Child", reverseRelation: {key: "mother", includeInJSON: false}, includeInJSON: true }] })
	var mo = new Mother({ "name" : "mum", "children" : [ { name:"john" }, { name:"joe" }]})

	console.debug( JSON.stringify( mo.toJSON() ) );
*/
	
/*
	window.Membership = Backbone.RelationalModel.extend({
		urlRoot: '/membership',
		relations: [
			{
				type: Backbone.HasOne,
				key: 'user',
				relatedModel: 'User',
				//reverseRelation: {
				//	key: 'memberships',
				//	relatedModel: 'Membership'
				//}
			}
		]
	});

	window.User = Backbone.RelationalModel.extend({
		urlRoot: '/user',
		relations: [
			{
				type: Backbone.HasMany,
				key: 'memberships',
				relatedModel: 'Membership'
			}
		]
	});


	window.UserCollection = Backbone.Collection.extend({model:User});
	window.MembershipCollection = Backbone.Collection.extend({model:Membership});

	member = new Membership({
		"id": 4,
		"user": {
			"id": 7,
			"username": "paul",
			"email": "paul@mail.com",
			'memberships': [ 4 ]
		}
	})

	console.log("memberships nb: " + Backbone.Relational.store.find(User, 7).get("memberships").size());
*/

/*
	Game = Backbone.RelationalModel.extend({
	  relations: [{
		type: Backbone.HasMany,
		key: 'cards',
		relatedModel: 'Card',
		reverseRelation: {
		  type: Backbone.HasOne,
		  includeInJSON: false,
		  key: 'game'
		}
	  }],
	  url: '/bugs/json.json'
	});

	Card = Backbone.RelationalModel.extend({
	  relations: [{
		type: Backbone.HasMany,
		key: 'actions',
		relatedModel: 'Action',
		reverseRelation: {
		  type: Backbone.HasOne,
		  includeInJSON: false,
		  key: 'card'
		}
	  }]
	});

	Action = Backbone.RelationalModel.extend({});

	game = new Game ({
		"name": "First Game",
		"id": 4,
		"cards": [
			{
				"title": "Test scenario"
			},
			{
				"title": "Other scenario",
				"id": 105,
				"actions": [
					{
						"name": "cut",
						"id": 41
					},
					{
						"name": "call"
					}
				]
			}
		]
	});

	game.set( {
		id: 4,
		type: 'Card game',
		cards: [
			{
				id: 34
			},
			{
				id: 105,
				actions: [
					{
						id: 41,
						rating: 'good'
					},
					{
						id: 42,
						rating: 'bad'
					}
				]
			}
		]
	});
*/

/*
	var bill = new Backbone.Model({
	  name: "Bill Smith"
	});

	bill.bind("change:name", function(model, name) {
	  alert("Changed name from " + bill.previous("name") + " to " + name);
	});

	bill.set({name : "Bill Jones"});
*/


Person = Backbone.RelationalModel.extend({
    initialize: function(){
        var dit = this;
		this.bind('update:jobs', function(company) {
            console.debug( this.get('name') + ' says: "My company has been updated to ' + company.get('name') + '"' );
        }, this);
		
		this.bind( 'change', function() {
				dit.get( 'jobs' ).each( function( job ) {
						job.get( 'company' ).trigger( 'update:employees', dit );
					});
			});
    },
    relations: [
        {
            type: 'HasMany',
            key: 'jobs',
            relatedModel: 'Job',
            reverseRelation: {
                key: 'person'
            }
        }
    ],
    getCompanies: function(){
        return this.get('jobs').pluck('company');
    }
});

Job = Backbone.RelationalModel.extend({
    initialize: function(){
		this.bind( 'update:person', function() {
				console.debug( 'update:person; arguments=%o', arguments );
			});
		this.bind( 'update:company', function() {
				console.debug( 'update:company; arguments=%o', arguments );
			});
	}
});

Company = Backbone.RelationalModel.extend({
    initialize: function(){
        var dit = this;
		
		this.bind('update:employees', function(person) {
            console.debug( this.get('name') + ' says: "My employee has been updated to ' + person.get('name') + '"' );
        }, this);
		
		this.bind( 'change', function() {
				dit.get( 'employees' ).each( function( employee ) {
						employee.get( 'person' ).trigger( 'update:jobs', dit );
					});
			});
    },
    relations: [
        {
            type: 'HasMany',
            key: 'employees',
            relatedModel: 'Job',
            reverseRelation: {
                key: 'company'
            }
        }
    ],
    getPersons: function(){
        return this.get('employees').pluck('person');
    }
});

ibm = new Company({
    id: 1, 
    name: 'IBM'
});
bmw = new Company({
    id: 2,
    name: 'BMW'
});
pepsi = new Company({
    id: 3,
    name: 'Pepsi'
});

me = new Person({
    id: 1, 
    name:'Old Me'
});

me.get('jobs').add([{company: ibm}, {company: bmw}, {company: pepsi}, {company: pepsi}, {company: pepsi}]);
//ibm.get('employees').add([{person: me}]);
//bmw.get('employees').add([{person: me}]);
//pepsi.get('employees').add([{person: me}]);

//me.set({name: 'New Me'});
//pepsi.set({name: 'New Pepsi'});
me.get('jobs').at(0).set( { company: bmw } );
	</script>
</body>
</html>